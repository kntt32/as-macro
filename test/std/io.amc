import core;
import core.str;
import core.cmp;
import std.syscall;
import core.fmt;

pub const stdin: i32 = 0;
pub const stdout: i32 = 1;
pub const stderr: i32 = 2;

pub struct Io {
    fd: i32,
    buff: [char; 1024],
    len: i64,
};

impl Display(Io);

pub as new(out self: Io@mem, in fd: i32@reg+imm) {
    self.fd = fd;
    self.len = 0;
};

pub as flush(inout self: Io@mem) {
    let selflen: i64@rax = self.len;
    let flag: bool@rax;
    if(neq(flag, self.len, 0)) {
        let msg: *char@rsi;
        msg =& self.buff;
        let len: i64@rdx = self.len;
        let fd: i32@rdi = self.fd;
        write(fd, msg, len);
        self.len = 0;
    };
};

pub as write(inout self: Io@mem, in str: Str@mem) {
    let str_ptr: *char@rax;
    str.as_ptr(str_ptr);
    let str_ptr_i8: *i8@rdx = str_ptr;
    let len: i64@rcx;
    str.len(len);
    self.write(str_ptr_i8, len);
};

pub as write(inout self: Io@mem, in data: *i8@reg+mem, in len: i64@rcx) {
    let buff_new_len: i64@r8 = self.len;
    buff_new_len += len;
    let flag: bool@rax;
    if(ge(flag, buff_new_len, 1024)) {
        flush(self);
    };

    let dst: *void@rdi;
    dst =& self.buff;
    dst += self.len;
    let src: *void@rsi;
    src = data;

    memcpy(dst, src, len);
    self.len += len;

    data;len;
};


